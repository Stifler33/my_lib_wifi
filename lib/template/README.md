# üõ†Ô∏è –§—Ä–µ–π–º–≤–æ—Ä–∫ $\text{ESP32}$ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ $\text{Wi-Fi}$ –∏ $\text{OTA}$

–≠—Ç–æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è $\text{ESP32}$, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é $\text{Wi-Fi}$ —á–µ—Ä–µ–∑ $\text{Access Point}$ ($\text{AP}$) –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç $\text{OTA}$ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

## üöÄ –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã

### 1\. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫:

  * **$\text{GTimer}$**: –î–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö —Ç–∞–π–º–µ—Ä–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ—Ä–≥–∞–Ω–∏—è $\text{LED}$).
  * **$\text{PubSubClient}$**: –î–ª—è $\text{MQTT}$ (—Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω—ã, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º –∫–æ–¥–µ, –Ω–æ –≤–∞–∂–Ω—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è).

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –≤–∞—à–µ–π $\text{Arduino IDE}$.

### 2\. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- |
| `template.h` | –û–±—ä—è–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏). |
| `template.cpp` | –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ $\text{Wi-Fi}$, $\text{LED}$, $\text{OTA}$, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ $\text{Web}$ $\text{Server}$ –∏ —Å–±—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. |
| `html_content.h` | $\text{HTML}$ –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –≤ –≤–∏–¥–µ $\text{C}$ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã. |

### 3\. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Ñ–∞–π–ª `.ino` –∏–ª–∏ `main.cpp`)

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ –≤–∞–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `setup()` –∏ `loop()`.

```cpp
#include "template.h"

// –ü–∏–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Wi-Fi
// –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–∏–Ω 0 (–∫–Ω–æ–ø–∫–∞ BOOT –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ ESP32)
#define RESET_BUTTON_PIN 0 

void setup() {
  // 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∏–Ω–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  set_pin_reset(RESET_BUTTON_PIN); 

  // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º: Wi-Fi, Preferences (–ø–∞–º—è—Ç—å), WebServer
  init_stif(); 

  // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OTA –¥–ª—è –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  arduino_ota_initial(); 

  // 4. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MQTT
  // mqtt_initial(); 
}

void loop() {
  // 1. –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Wi-Fi, LED –∏ WebServer/OTA
  loop_status_wifi(); 

  // 2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¶–∏–∫–ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è MQTT
  // mqtt_reconnect(); 

  // –í–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –∑–¥–µ—Å—å...
}
```

-----

## ‚öôÔ∏è –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –†–µ–∂–∏–º—ã Wi-Fi

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ $\text{ESP32}$ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

1.  **–ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è $\text{Wi-Fi}$ $\text{STA}$ (–∫–ª–∏–µ–Ω—Ç) —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
      * $\text{ESP32}$ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º $\text{WIFI\_STA}$ –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–µ—Ç–∏.
      * $\text{LED}$ **–±—ã—Å—Ç—Ä–æ –º–æ—Ä–≥–∞–µ—Ç** (—Ç–∞–π–º–∞—É—Ç 100 $\text{–º—Å}$) –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
      * –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è $\text{LED}$ **–ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≥–æ—Ä–∏—Ç**.
      * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è $\text{ArduinoOTA}$.
2.  **–ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ $\text{Wi-Fi}$ $\text{STA}$ –Ω–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞):**
      * $\text{ESP32}$ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º **$\text{WIFI\_AP}$** (–¢–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞).
      * **$\text{SSID}$ $\text{AP}$ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `ESP32_APP`** (–±–µ–∑ –ø–∞—Ä–æ–ª—è).
      * $\text{LED}$ **–º–µ–¥–ª–µ–Ω–Ω–æ –º–æ—Ä–≥–∞–µ—Ç** (—Ç–∞–π–º–∞—É—Ç 500 $\text{–º—Å}$), —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—è –æ —Ä–µ–∂–∏–º–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
      * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è $\text{WebServer}$ –Ω–∞ –ø–æ—Ä—Ç—É 80.

### üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–í —Ä–µ–∂–∏–º–µ $\text{AP}$:

1.  –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ $\text{Wi-Fi}$ —Å–µ—Ç–∏ **`ESP32_APP`**.
2.  –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ –∞–¥—Ä–µ—Å—É **`192.168.4.1`**.
3.  –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
      * **–ò–º—è —Å–µ—Ç–∏ $\text{Wi-Fi}$ ($\text{SSID}$):** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
      * **–ü–∞—Ä–æ–ª—å $\text{Wi-Fi}$:** –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–µ—Ç–µ–π).
      * **–ò–º—è —Ö–æ—Å—Ç–∞ ($\text{Hostname}$):** –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
4.  –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è", $\text{ESP32}$ **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç** –¥–∞–Ω–Ω—ã–µ –≤ $\text{Preferences}$ (–ø–∞–º—è—Ç—å $\text{EEPROM}$) –∏ **–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è** –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ $\text{WIFI\_STA}$.

### üíæ –°–±—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

  * –ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –ø–∏–Ω, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–µ–π `set_pin_reset(PIN)`.
  * –ï—Å–ª–∏ –ø–∏–Ω —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ **2 —Å–µ–∫—É–Ω–¥** (—Ç–∞–π–º–µ—Ä `tmr_reset`), –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è $\text{Wi-Fi}$ —Å—Ç–∏—Ä–∞–µ—Ç—Å—è, $\text{ESP32}$ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º $\text{WIFI\_AP}$.

### üîÑ $\text{OTA}$ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

–ö–æ–≥–¥–∞ $\text{ESP32}$ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ç–∏ $\text{Wi-Fi}$ (—Ä–µ–∂–∏–º $\text{WIFI\_STA}$):

  * –û–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—à–∏–≤–∫–∏ (Over-The-Air) —á–µ—Ä–µ–∑ $\text{Arduino IDE}$ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
  * –í–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è $\text{LED}$ **–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –º–æ—Ä–≥–∞–µ—Ç** (—Ç–∞–π–º–∞—É—Ç 20 $\text{–º—Å}$).
  * **–ò–º—è —Ö–æ—Å—Ç–∞**, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã –∑–∞–¥–∞–µ—Ç–µ —á–µ—Ä–µ–∑ $\text{Web}$-—Ñ–æ—Ä–º—É, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–µ—Ç–µ–≤–æ–≥–æ –∏–º–µ–Ω–∏ –¥–ª—è $\text{OTA}$.
      * *(–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∑–∞–¥–∞–ª–∏ "my-device", –∏—â–∏—Ç–µ –µ–≥–æ –∫–∞–∫ `my-device.local` –≤ $\text{Arduino IDE}$)*.